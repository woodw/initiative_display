<!DOCTYPE HTML>
<html>
	<head>
		<title>Dnd Visual Aid</title>
		<link href="/style/style.css" rel="stylesheet" type="text/css" />
	
		<script src="/socket.io/socket.io.js"></script>
		<script>
			let app = {
				backdrop: 'linear-gradient'
			};

			document.addEventListener('DOMContentLoaded', function() {
				let socket,elements;

				app.init = init;
				
				app.init();

				function init(){
					elements = registerElements();
					initSocket();
				}

				function registerElements(){
					return {
						backDropFront: byCSS('.stage-backdrop.front'),
						backDropBack: byCSS('.stage-backdrop.back'),
						sketchContainer: byCSS('#sketch--container'),
						sketch: byCSS('#sketch-cover'),
						characterLine: byCSS('#stage-character_line')
					}
				}

				function byCSS(cssSelector){
					return document.querySelector(cssSelector);
				}

				function changeTheBackDrop(newImage){
					elements.backDropFront.style.backgroundImage = elements.backDropBack.style.backgroundImage;
					elements.backDropBack.style.backgroundImage = 'url('+newImage+')';
					elements.backDropFront.classList.remove('hide');
					window.setTimeout(function(){
						elements.backDropFront.classList.add('hide');
					},500);
				}

				function playEmoji(cssSelect, emoji){
					console.log('find this',cssSelect);
					var temp = byCSS(cssSelect);
					temp.classList.remove('play');
					void temp.offsetWidth;
					temp.innerText = emoji;
					temp.classList.add('play');
				}

				function initSocket(){
					socket = io.connect(window.location.href.replace(window.location.pathname,''));
					
					
					socket.on('socket connection', function (data) {
						console.log(data);
					});
					socket.on('set backdrop', function (data) {
						changeTheBackDrop(data.url);
						console.log(data);
					});
					socket.on('set sketch', function (data) {
						console.log(data);
						elements.sketch.style.backgroundImage = 'url('+data.url+')';
						elements.sketchContainer.classList.remove('hide');
					});
					socket.on('hide sketch', function (data) {
						console.log(data);
						elements.sketchContainer.classList.add('hide');
					});
					socket.on('set players', function (data) {
						console.log(data);
					});
					socket.on('set npcs', function (data) {
						console.log(data);
					});

					socket.on('set emoji', function (data) {
						console.log('set emoji',data);
						playEmoji('.pc.'+data.character+' .emoji',data.emoji);
					});

					socket.on('create actor', function(data){
						console.log(data);
						var newActor, em, mi;
						newActor = document.createElement('div');
						em = document.createElement('div');
						em.className = 'emoji';
						newActor.appendChild(em);
						mi = document.createElement('div');
						mi.className = 'mini';
						newActor.appendChild(mi);
						newActor.className = data.classes;
						newActor.setAttribute('dndid',data.id);
						//newActor.innerHTML = '<div class="emoji"></div><div class="mini"></div>';
						if(data.classes.indexOf('npc')!== -1){
							elements.characterLine.prepend(newActor);						
						}
						else{
							elements.characterLine.appendChild(newActor);						
						}

					});

					socket.on('set actor', function(data){
						console.log(data);
						var actor = elements.characterLine.querySelector('div[dndid="'+data.id+'"]');
						actor.className = data.classes;
						playEmoji('div[dndid="'+data.id+'"] .emoji',data.emoji);
					});
					
					socket.on('delete actor', function(data){
						console.log(data);
						var actor = elements.characterLine.querySelector('div[dndid="'+data.id+'"]');
						actor.parentNode.removeChild(actor);
					});

				}
	
			});	
		</script>
	</head>
	<body>
		<div id="stage-background">
			<div id="stage-wall">
				<div class="stage-backdrop back" style="background-image:url(https://files.slack.com/files-pri/T5MRA9Z4L-F8Y16L71T/dnd_group.jpg);"></div>
				<div class="stage-backdrop front hide" style="background-image:url(https://files.slack.com/files-pri/T5MRA9Z4L-F8Y16L71T/dnd_group.jpg);"></div>
			</div>
			<div id="stage-trim"></div>
			<div id="stage-floor"></div>
		</div>
		<div id="stage-foreground">
			<div id="stage-character_line">
						
				
			</div>
		</div>
		<div id="sketch--container" class="hide">
			<div id="sketch-cover" style="background-image:url('http://www.dan-site.com/Pathfinder_Witch_Spell_List/frank_frazetta_thesorcerer.jpg');"></div>
		</div>
	</body>
</html>