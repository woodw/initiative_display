<!DOCTYPE HTML>
<html>
	<head>
		<title>Dungeon Master Screen</title>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			let app = {};

			document.addEventListener('DOMContentLoaded', function() {
				let socket,backdrops,sketches,elements, actors, uniqueID, initiativePointer;

				app.init = init;
				
				app.init();

				function init(){
					elements = registerElements();
					registerListeners();
					initSocket();
					actors=[];
					uniqueID = 0;
					initiativePointer = 0;
				}

				function initSocket(){
					socket = io.connect(window.location.href.replace(window.location.pathname,''));
					
					socket.on('socket connection', function (data) {
						console.log(data);
					});

					socket.emit('get backdrops');

					socket.emit('get sketches');

					socket.on('send backdrops', function(data){
						backdrops = data;
						
						backdrops.session[0].forEach(function(backdrop){
							newBackDropOption(elements.backDropList,backdrop);
						});

						if(backdrops.session[0].length>0){
							elements.backDropList.value = backdrops.session[0][0].url;
							elements.backDropPreview.style.backgroundImage = 'url('+elements.backDropList.value+')';						
						}
					});

					socket.on('send sketches', function(data){
						sketches = data;
						
						sketches.session[0].forEach(function(sketch){
							newBackDropOption(elements.sketchList,sketch);
						});
						
						if(sketches.session[0].length>0){
							elements.sketchList.value = sketches.session[0][0].url;
							elements.sketchPreview.style.backgroundImage = 'url('+elements.sketchList.value+')';						
						}
					});
				}

				function newBackDropOption(selectElm,optionObj){
					var element;
					
					element = document.createElement('option');
					element.value = optionObj.url;
					element.text = optionObj.name;
					
					selectElm.appendChild(element);

				}

				function registerElements(){
					return {
						container: byCSS('#container'),
						tabs: document.querySelectorAll('.tab'),
						backDropTab: byCSS('#back-drop_tab'),
						backDropList: byCSS('#back-drop_list'),
						backDropSubmit: byCSS('#back-drop_button'),
						backDropPreview: byCSS('#back-drop_preview'),
						backDropCustomUrl: byCSS('#back-drop_custom'),
						backDropUseCustomUrl: byCSS('#back-drop_use_custom'),
						sketchTab: byCSS('#sketch_tab'),
						sketchList: byCSS('#sketch_list'),
						sketchShow: byCSS('#sketch_button--show'),
						sketchHide: byCSS('#sketch_button--hide'),
						sketchPreview: byCSS('#sketch_preview'),
						sketchCustomUrl: byCSS('#sketch_custom'),
						sketchUseCustomUrl: byCSS('#sketch_use_custom'),
						actorList: byCSS('#actor_list'),
						actorAdd: byCSS('#actor--add'),
						actorAddSubmit: byCSS('#actor--add button'),
						initiativesClearBtn: byCSS('#initiative--clear'),
						initiativesFillBtn: byCSS('#initiative--fill'),
						initiativeCurrentBtn: byCSS('#initiative--current'),
						initiativeNextBtn: byCSS('#initiative--next')
					};
				}

				function addEventListenerList(list, event, fn) {
					for (var i = 0, len = list.length; i < len; i++) {
						list[i].addEventListener(event, fn, false);
					}
				}

				function byCSS(cssSelector){
					return document.querySelector(cssSelector);
				}

				function registerListeners(){

					elements.backDropList.addEventListener('change', function(event, no){
						elements.backDropPreview.style.backgroundImage = 'url('+elements.backDropList.value+')';
					});
					elements.backDropSubmit.addEventListener('click', function(event){
						if(elements.backDropCustomUrl.value.length>7 && elements.backDropUseCustomUrl.checked){
							socket.emit('update backdrop',{'url':elements.backDropCustomUrl.value});
						}
						else{
							socket.emit('update backdrop',{'url':elements.backDropList.value});
						}
					});

					elements.sketchList.addEventListener('change', function(event, no){
						elements.sketchPreview.style.backgroundImage = 'url('+elements.sketchList.value+')';
					});
					elements.sketchShow.addEventListener('click', function(event){

						if(elements.sketchCustomUrl.value.length>7 && elements.sketchUseCustomUrl.checked){
							socket.emit('update sketch',{'url':elements.sketchCustomUrl.value});
						}
						else{
							socket.emit('update sketch',{'url':elements.sketchList.value});
						}
					});
					elements.sketchHide.addEventListener('click', function(event){
						console.log('hude');
						socket.emit('hide sketch');
					});
					elements.actorAddSubmit.addEventListener('click', function(){
						var newActor, actorAddElements;
						
						actorAddElements = {
							classes: byCSS('#actor--add input:nth-child(1)'),
							hitpoints: byCSS('#actor--add input:nth-child(2)'),
							description: byCSS('#actor--add input:nth-child(3)')
						};
						
						if(actorAddElements.classes.value){

							newActor = new Actor(actorAddElements);
							elements.actorList.appendChild(newActor.elements.container);
							actors.push(newActor);
						}
					});

					elements.initiativesClearBtn.addEventListener('click',function(event){
						while (elements.actorList.firstChild) {
							elements.actorList.removeChild(elements.actorList.firstChild);
						}
						actors.forEach(function(actor){
							actor.initiative = 0;
							actor.elements.initiative.value = actor.initiative;
						});
						actors.sort(function(a,b){
							return a.id - b.id;
						});
						actors.forEach(function(actor){
							elements.actorList.appendChild(actor.elements.container);
						});
						initiativePointer = 0;
					});

					elements.initiativesFillBtn.addEventListener('click',function(event){
						while (elements.actorList.firstChild) {
							elements.actorList.removeChild(elements.actorList.firstChild);
						}
						actors.forEach(function(actor){
							actor.initiative = actor.initiative||Math.ceil(Math.random()*20);
							actor.elements.initiative.value = actor.initiative;
						});
						actors.sort(function(a,b){
							return a.initiative - b.initiative;
						});
						actors.forEach(function(actor){
							elements.actorList.appendChild(actor.elements.container);
						});
					});

					elements.initiativeCurrentBtn.addEventListener('click',function(event){
						actors[initiativePointer].elements.point.click();
					});

					elements.initiativeNextBtn.addEventListener('click',function(event){
						if(initiativePointer++ < actors.length-1){
							actors[initiativePointer].elements.point.click();
						}
						else{
							initiativePointer = 0;
							actors[0].elements.point.click();
						}						
					});
				}

				/*Actor Object Class*/
				function Actor(actorAddElements){
					this.elements = buildNewActor.call(this,actorAddElements);
					this.id = null;
					this.initiative = null;
					
					registerActorEventListeners.call(this);
					console.log('sending add actor');
					//send out emit for stage to pick up	
					socket.emit('add actor', toJSON.call(this), (data) => {
						console.log('i got back an ID from the server');
						this.id = data.id;
					});	

					function toJSON(){
						return {
							id:this.id,
							classes:this.elements.classes.value,
							emoji:this.elements.emoji.value
						};
					};

					function registerActorEventListeners(){

						this.elements.update.addEventListener('click', function(event){
							console.log('sending update actor');
							socket.emit('update actor', toJSON.call(this));		
						}.bind(this));  

						this.elements.remove.addEventListener('click', function(event){
							console.log('sending remove actor talk');
							socket.emit('remove actor', {id:this.id});
							this.elements.container.parentNode.removeChild(this.elements.container);
							this.alive = true;
						}.bind(this));  

						this.elements.point.addEventListener('click', function(event){
							this.elements.emoji.innerText = '👇';
							socket.emit('update actor', toJSON.call(this));
							this.elements.emoji.innerText = '';
						}.bind(this));

						this.elements.initiative.addEventListener('change', function(event){
							this.initiative = this.elements.initiative.value;
						}.bind(this));

						this.elements.onstage.addEventListener('click', function(event){
							if(this.elements.classes.value.indexOf('onstage')!=-1){
								this.elements.classes.value = this.elements.classes.value.replace(' onstage','');
								
							}else{
								this.elements.classes.value = this.elements.classes.value+' onstage';
							
							}
							this.elements.emoji.innerText = '';
							socket.emit('update actor', toJSON.call(this));
						}.bind(this));

						this.elements.turn.addEventListener('click', function(event){
							if(this.elements.classes.value.indexOf('turn')!=-1){
								this.elements.classes.value = this.elements.classes.value.replace(' turn','');
								
							}else{
								this.elements.classes.value = this.elements.classes.value+' turn';
							
							}
							this.elements.emoji.innerText = '';
							socket.emit('update actor', toJSON.call(this));
						}.bind(this));
					}
					
					function buildNewActor(actorAddElements){
						var elements={};

						elements.container = document.createElement('div');
						elements.container.className = 'actor--update';

						elements.classes = document.createElement('input');
						elements.classes.setAttribute("type", "text");
						elements.classes.setAttribute("placeholder", "css classes");
						elements.classes.value = actorAddElements.classes.value;

						elements.container.appendChild(elements.classes);
						
						elements.hitpoints = document.createElement('input');
						elements.hitpoints.setAttribute("type", "number");
						elements.hitpoints.setAttribute("placeholder", "10");
						elements.hitpoints.value = actorAddElements.hitpoints.value;
						
						elements.container.appendChild(elements.hitpoints);  
						
						elements.description = document.createElement('input');
						elements.description.setAttribute("type", "text");
						elements.description.setAttribute("placeholder", "brief description");
						elements.description.value = actorAddElements.description.value;
						
						elements.container.appendChild(elements.description);
						
						elements.initiative = document.createElement('input');
						elements.initiative.setAttribute("type", "number");
						elements.initiative.setAttribute("placeholder", "1");
						
						elements.container.appendChild(elements.initiative);
						
						elements.emoji = document.createElement('input');
						elements.emoji.setAttribute("type", "text");
						elements.emoji.setAttribute("placeholder", "😀");
						
						elements.container.appendChild(elements.emoji);
						
						elements.update = document.createElement('button');
						elements.update.innerText = '✔';
						
						elements.container.appendChild(elements.update);
						
						elements.remove = document.createElement('button');
						elements.remove.innerText = '✖';
						
						elements.container.appendChild(elements.remove);

						elements.point = document.createElement('button');
						elements.point.innerText = '👇';  
						
						elements.container.appendChild(elements.point);

						elements.onstage = document.createElement('button');
						elements.onstage.innerText = 'toggle onstage';  
						
						elements.container.appendChild(elements.onstage);

						elements.turn = document.createElement('button');
						elements.turn.innerText = 'toggle turn';  
						
						elements.container.appendChild(elements.turn);

						return elements;
					}
				}

			});	
		</script>
		<style>
			*{
				margin:0;
				padding:0;
				color:white;
				font-family: Arial, Helvetica, sans-serif;
			}
			body{
				background-color:rgba(27, 44, 49, 0.925);
			}
			div#container{
				margin-left:10vw;
				margin-right:10vw;
				width:80vw;
			}
			section{
				margin-top:5vh;
				margin-bottom:5vh;
				border:1px solid rgba(0,0,0,.5);
				box-shadow:0 0 10px 2px rgba(0,0,0,.5);
				padding:1vh 1vw;
				background-color:rgba(42, 68, 77, 0.925);
			}
			#back-drop_preview, #sketch_preview{
				width:70vw;
				height:40vh;
			}
			.image{
				margin:2vh 2vw;
				background-position:center;
				background-size:contain;
				background-repeat:no-repeat;
			}
			#actors div > input:nth-child(2){
				width:3rem;
			}

			#actors div > input:nth-child(4){
				width:3rem;
			}

			#actors div > input:nth-child(5){
				width:3rem;
			}
			button,select,input{
				padding:1vh 1vw;
			}
			button,select{
				background-color:rgba(64, 105, 119, 0.925);
			}
			input{
				color:rgb(48, 41, 36);
			}
		</style>
	</head>
	<body>
		<div id="container">
			<h1>DM Screen</h1>
			<section id="sketches">
				<div id="sketch_preview" class="image" style="background-image:linear-gradient(white, grey);"></div>
				<select id="sketch_list"></select>
				<button id="sketch_button--show">Show Sketch</button>
				<button id="sketch_button--hide">Hide Sketch</button>
				<br />
				<input type="url" id="sketch_custom" placeholder="custom url"/>
				<input type="checkbox" id="sketch_use_custom">
      			<label for="sketch_use_custom">Use Custom Url?</label>
				
				
			</section>
			<section id="backdrops">
				<div id="back-drop_preview" class="image" style="background-image:linear-gradient(white, grey);"></div>
				<select id="back-drop_list"></select>
				<button id="back-drop_button">Update Backdrop</button>
				<br />
				<input type="url" id="back-drop_custom" placeholder="custom url"/>
				<input type="checkbox" id="back-drop_use_custom">
      			<label for="back-drop_use_custom">Use Custom Url?</label>
			</section>
			<section id="actors">
				<p>!  $  ?  0  1  2  3  4  5  6  7  8  9  ✔  ✖  ⌕  ⏸  ▷  ☼  ☾  ★  ♥  ♫  ⚒  ⚔  ➳  ⛏  ☀  ☠  ⚓  ⛵  ⛺  ✨  ⏳  💀  😃  😇  😈  😉  😍  😎  😏  😐  😠  😢   😮 😱 😲 😴 😵 ⚰ 🌲 🌿 🍗 🍴 🍺 🍻 🎣 🎨 🎪 🎸 🐃 🐎 🐾 👂 👆 👇 👈 👉 👊 👋 👌 👍 👎 👏 👑 👣 👤 👥 💎 💕 💔 💘 💢 💣 💤 💩 💪 💰 🔑 🔒 🔓 🔥 🔧 🔨 🔮 🔪 ⌕</p>
					
				<div id="actor--add">
					<input type="text" placeholder="css classes"/>
					<input type="number" placeholder="10"/>
					<input type="text" placeholder="brief description"/>
					<button >+</button>
				</div>
				<div>
					<button id="initiative--clear">empty initiatives</button>
					<button id="initiative--fill">fill initiatives</button>
					<button id="initiative--current">show current initiative</button>
					<button id="initiative--next">set next initiative</button>
				</div>
				<div id="actor_list"></div>
		
				
			</section>
		</div>
	</body>
</html>